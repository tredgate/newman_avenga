name: Newman with Summary in GitHub Actions
on: workflow_dispatch
jobs:
  newman_tests:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
      - name: Install dependencies
        run: npm ci
      - name: Run Newman tests
        run: npx newman run "./collections/Newman Failing Tests.postman_collection.json" -r cli,json,htmlextra --reporter-json-export newman/newman-run-report.json --reporter-htmlextra-export newman/html-report.html
      - name: Upload HTML Report as Artifact
        uses: actions/upload-artifact@v6
        if: ${{ !cancelled() }}
        with:
          name: newman-html-report
          path: newman/html-report.html
      # Vygenerování souhrnu výsledků testů v GitHub Actions Summary (JavaScript v rámci Node.js), lze rozšířit (čerpá z json reportu vytvořeného v Newman)
      - name: Generate Newman Summary
        if: ${{ !cancelled() }}
        run: |
          node -e '
          const fs = require("fs");

          try {
            // Načtení JSON reportu z Newman
            const report = JSON.parse(fs.readFileSync("newman/newman-run-report.json", "utf8"));
            const stats = report.run.stats;
            const timings = report.run.timings;
            
            // Funkce pro určení emoji podle stavu
            function getEmoji(stat) {
              if (stat.pending > 0) return "↩️";
              if (stat.failed > 0) return "❌";
              return "✅";
            }
            
            // Vytvoření markdown tabulky
            let summary = "## Newman Test Summary\n\n";
            summary += "| | | Executed | Failed |\n";
            summary += "|---|---|---|---|\n";
            summary += `|  ${getEmoji(stats.iterations)} | iterations | ${stats.iterations.total} | ${stats.iterations.failed} |\n`;
            summary += `|  ${getEmoji(stats.requests)} | requests | ${stats.requests.total} | ${stats.requests.failed} |\n`;
            summary += `|  ${getEmoji(stats.testScripts)} | test-scripts | ${stats.testScripts.total} | ${stats.testScripts.failed} |\n`;
            summary += `| ${getEmoji(stats.prerequestScripts)} | prerequest-scripts | ${stats.prerequestScripts.total} | ${stats.prerequestScripts.failed} |\n`;
            summary += `| ${getEmoji(stats.assertions)} | assertions | ${stats.assertions.total} | ${stats.assertions.failed} |\n`;
            
            // Přidání časových informací
            const duration = timings.completed - timings.started;
            const avgResponse = timings.responseAverage;
            summary += `\n**Total run duration:** ${duration}ms\n`;
            summary += `**Average response time:** ${avgResponse}ms\n`;
            
            // Zápis do GitHub Actions Summary
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
            
          } catch (error) {
            // Zobrazení chyby pokud se nepodaří načíst nebo zpracovat report
            const errorMsg = `## ❌ Newman Summary Generation Failed\n\n**Error:** ${error.message}\n`;
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, errorMsg);
          }
          '
